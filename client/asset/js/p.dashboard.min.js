var currentMarkType = null // 1 = Pin Drop, 2 = Area Mark, 3 = Circle Mark
var prevMarkType = null
var markPinDrops = []
var markArea = []
var markCircle = []
var drawingManager = null
var selectedShape
var pageWrapper = $("#page-dashboard")

function initMarkTrigger(){
  var selectHand = $('#mark-trigger-select')
  var pinDrop = $('#mark-trigger-pin-drop')
  var areaMark = $('#mark-trigger-area')
  var circleMark = $('#mark-trigger-circle')
  var currentMark = $('#mark-current')

  function initCurrentMark(type, pointer){
    currentMarkType = type
    currentMark.empty().append(pointer.html())
    pointer.closest('ul').find('li a').removeClass('active')
    pointer.addClass('active')
  }

  selectHand.unbind().on("click", function(event){
    event.preventDefault()
    initCurrentMark(1, $(this))
    if(drawingManager){
      drawingManager.setMap(null)
      drawingManager.setOptions({
        drawingMode: null
      })

      drawingManager.setMap(mapincGoogleMap['dashboard-map'])
    }
  })

  pinDrop.unbind().on("click", function(event){
    event.preventDefault()
    initCurrentMark(2, $(this))
    if(drawingManager){
      drawingManager.setMap(null)
      drawingManager.setOptions({
        drawingMode: google.maps.drawing.OverlayType.MARKER
      })

      drawingManager.setMap(mapincGoogleMap['dashboard-map'])
    }
  })

  areaMark.unbind().on("click", function(event){
    event.preventDefault()
    initCurrentMark(3, $(this))
    if(drawingManager){
      drawingManager.setMap(null)
      drawingManager.setOptions({
        drawingMode: google.maps.drawing.OverlayType.POLYGON
      })

      drawingManager.setMap(mapincGoogleMap['dashboard-map'])
    }
  })

  circleMark.unbind().on("click", function(event){
    event.preventDefault()
    initCurrentMark(4, $(this))
    if(drawingManager){
      drawingManager.setMap(null)
      drawingManager.setOptions({
        drawingMode: google.maps.drawing.OverlayType.CIRCLE
      })

      drawingManager.setMap(mapincGoogleMap['dashboard-map'])
    }
  })
}

function initMapAction(){
  iconImage = 'asset/image/marker-pin-add.png'

  drawingManager = new google.maps.drawing.DrawingManager({
    drawingMode: google.maps.drawing.OverlayType.POLYGON,
    drawingControl: false,
    markerOptions: {icon: iconImage},
    polygonOptions: {
      fillColor: mapincColorMain2,
      fillOpacity: 0.4,
      strokeColor: mapincColorMain1,
      strokeWeight: 2,
      editable: true
    },
    circleOptions: {
      fillColor: mapincColorMain2,
      fillOpacity: 0.4,
      strokeColor: mapincColorMain1,
      strokeWeight: 2,
      clickable: false,
      editable: true,
      zIndex: 1
    }
  })

  function setSelection(shape){
    selectedShape = shape
  }

  google.maps.event.addListener(drawingManager, 'overlaycomplete', function (e) {
    var newShape = e.overlay
    var shapeIcon = newShape.icon
    newShape.type = e.type

    console.log(newShape);

    if(e.type === google.maps.drawing.OverlayType.MARKER){
      google.maps.event.addListener(newShape, 'click', function(e){
        var actionClose = pageWrapper.find('.detail-wrapper .detail-close')
        newShape.setIcon('asset/image/marker-pin-add-active.png')
        pageWrapper.addClass('open-detail')
        actionClose.unbind().on('click', function(){
          pageWrapper.removeClass('open-detail')
          newShape.setIcon(shapeIcon)
          mapincGoogleMap['dashboard-map'].setOptions({'draggable': true, 'scrollwheel': true})
        })
        mapincGoogleMap['dashboard-map'].panTo({lat:e.latLng.lat(), lng:e.latLng.lng() + 0.00909})
        mapincGoogleMap['dashboard-map'].setOptions({'draggable': false, 'scrollwheel': false})
        setSelection(newShape)
      })
      setSelection(newShape)
    }
  })
}

function initDashboard(){
  initMarkTrigger()
  initMapAction()
}

$(function(){
  verify(initDashboard(), false, 'p.signin.html')
})
